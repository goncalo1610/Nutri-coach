<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NUTRI+ Coach</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #f0f4f8;
            --bg-app: #ffffff;
            --text-color: #1a202c;
            --text-muted: #718096;
            --card-bg: #ffffff;
            --primary: #38b2ac;
            --primary-light: rgba(56,178,172,0.12);
            --secondary: #805ad5;
            --prot-color: #e53e3e;
            --carb-color: #38a169;
            --fat-color: #d69e2e;
            --danger: #e53e3e;
            --success: #38a169;
            --radius: 18px;
            --shadow: 0 4px 14px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
            --nav-height: 65px;
            --header-height: 62px;
            --cal-card-gradient: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%);
        }
        body.dark-mode {
            --bg-body: #0d1117; --bg-app: #161b22; --text-color: #e2e8f0;
            --text-muted: #a0aec0; --card-bg: #21262d; --primary: #4fd1c5;
            --primary-light: rgba(79,209,197,0.15);
            --cal-card-gradient: linear-gradient(135deg, #1a2a2a 0%, #0d2626 100%);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin:0; padding:0; font-family:'Nunito',sans-serif; background-color:var(--bg-body); color:var(--text-color); padding-top:env(safe-area-inset-top); min-height:100vh; }
        #app-container { max-width:600px; margin:0 auto; background-color:var(--bg-app); min-height:100vh; position:relative; box-shadow:0 0 40px rgba(0,0,0,0.08); padding-bottom:calc(var(--nav-height) + 80px + env(safe-area-inset-bottom)); }
        header { height:var(--header-height); padding:0 16px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:50; background:rgba(255,255,255,0.92); backdrop-filter:blur(12px); border-bottom:1px solid rgba(0,0,0,0.06); }
        body.dark-mode header { background:rgba(22,27,34,0.92); border-bottom:1px solid rgba(255,255,255,0.08); }
        .header-title { font-size:1.15rem; font-weight:900; display:flex; flex-direction:column; align-items:center; line-height:1.1; letter-spacing:-0.5px; }
        .header-subtitle { font-size:0.62rem; font-weight:700; color:var(--primary); text-transform:uppercase; letter-spacing:1.5px; }
        .header-btn { background:transparent; border:none; color:var(--text-color); width:40px; height:40px; display:flex; align-items:center; justify-content:center; cursor:pointer; border-radius:50%; transition:background 0.2s; }
        .header-btn:hover { background:var(--primary-light); }
        .view-section { display:none; padding:20px 16px; animation:fadeIn 0.28s ease-out; }
        .view-section.active { display:block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
        .card { background-color:var(--card-bg); border-radius:var(--radius); padding:16px; margin-bottom:14px; box-shadow:var(--shadow); border:1px solid rgba(0,0,0,0.03); transition:transform 0.15s; }
        body.dark-mode .card { border:1px solid rgba(255,255,255,0.06); }
        .calorie-card { background:var(--cal-card-gradient) !important; cursor:pointer; }
        .calorie-card:active { transform:scale(0.99); }
        h2 { font-weight:900; font-size:1.4rem; margin:0 0 16px 0; letter-spacing:-0.5px; }
        h3 { font-weight:800; font-size:1.05rem; margin:0 0 12px 0; }
        label { font-size:0.78rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:4px; }
        input, select, textarea { width:100%; padding:13px 14px; margin:0 0 14px 0; border:1.5px solid rgba(0,0,0,0.08); border-radius:12px; background:var(--bg-body); color:var(--text-color); font-size:15px; font-family:'Nunito',sans-serif; font-weight:600; outline:none; transition:border-color 0.2s; }
        input:focus, select:focus, textarea:focus { border-color:var(--primary); }
        body.dark-mode input, body.dark-mode textarea, body.dark-mode select { border-color:rgba(255,255,255,0.1); background:#0d1117; color:var(--text-color); }
        button { width:100%; padding:15px; border:none; border-radius:12px; background-color:var(--primary); color:white; font-size:15px; font-weight:800; font-family:'Nunito',sans-serif; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; transition:transform 0.12s; }
        button:active { transform:scale(0.97); }
        button.secondary { background-color:#718096; }
        button.danger { background-color:var(--danger); }
        button.gemini-btn { background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%); box-shadow:0 4px 14px rgba(56,178,172,0.3); }
        body.dark-mode button.gemini-btn { background:linear-gradient(135deg,#4fd1c5 0%,#2d6a4f 100%); }
        button.outline { background:transparent; border:2px solid rgba(0,0,0,0.15); color:var(--text-color); box-shadow:none; }
        body.dark-mode button.outline { border-color:var(--primary); color:var(--primary); }
        button.small { padding:8px 14px; width:auto; font-size:0.82rem; border-radius:8px; }
        .gauge-wrapper { position:relative; display:flex; align-items:center; justify-content:center; }
        .gauge-svg { transform:rotate(-90deg); width:100%; height:100%; }
        .gauge-bg { fill:none; stroke:rgba(0,0,0,0.07); stroke-width:3.5; }
        body.dark-mode .gauge-bg { stroke:rgba(255,255,255,0.08); }
        .gauge-fill { fill:none; stroke-width:3.5; stroke-dasharray:100,100; stroke-dashoffset:100; transition:stroke-dashoffset 0.9s cubic-bezier(0.34,1.56,0.64,1); stroke-linecap:round; }
        .gauge-icon { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); }
        .bottom-nav { position:fixed; bottom:0; left:0; right:0; max-width:600px; margin:0 auto; background:rgba(255,255,255,0.94); backdrop-filter:blur(14px); display:flex; justify-content:space-around; align-items:center; height:calc(var(--nav-height) + env(safe-area-inset-bottom)); padding-bottom:env(safe-area-inset-bottom); box-shadow:0 -1px 0 rgba(0,0,0,0.06); z-index:100; }
        body.dark-mode .bottom-nav { background:rgba(22,27,34,0.96); border-top:1px solid rgba(255,255,255,0.08); }
        .nav-item { flex:1; display:flex; flex-direction:column; align-items:center; color:var(--text-muted); font-size:0.72rem; font-weight:700; cursor:pointer; padding:6px 0; transition:color 0.2s; }
        .nav-item.active { color:var(--primary); }
        .nav-fab-wrapper { position:relative; top:-22px; width:58px; height:58px; }
        .nav-fab { width:100%; height:100%; background:linear-gradient(135deg,var(--primary),var(--secondary)); border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; box-shadow:0 6px 20px rgba(56,178,172,0.45); font-size:1.5rem; transition:transform 0.15s; }
        .nav-fab:active { transform:scale(0.93); }
        .loader { display:none; text-align:center; padding:16px; color:var(--secondary); font-style:italic; font-size:0.9rem; animation:pulse 1.4s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
        .coach-message { background:var(--primary-light); border-left:4px solid var(--primary); color:var(--text-color); padding:14px 16px; border-radius:10px; margin-top:10px; font-size:0.95rem; line-height:1.65; white-space:pre-wrap; font-weight:600; }
        .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.65); backdrop-filter:blur(5px); z-index:1000; display:none; align-items:center; justify-content:center; padding:20px; }
        .modal-box { background:var(--card-bg); padding:28px 24px; border-radius:24px; width:100%; max-width:340px; text-align:center; box-shadow:var(--shadow-lg); border:1px solid rgba(255,255,255,0.1); animation:popIn 0.25s cubic-bezier(0.34,1.56,0.64,1); }
        @keyframes popIn { from{transform:scale(0.85);opacity:0} to{transform:scale(1);opacity:1} }
        .modal-box h3 { margin:0 0 8px 0; }
        .modal-box p { color:var(--text-muted); font-size:0.9rem; margin-bottom:16px; }
        .shortcuts-container { display:flex; overflow-x:auto; gap:8px; padding:5px 0 14px 0; scrollbar-width:none; }
        .shortcuts-container::-webkit-scrollbar { display:none; }
        .shortcut-item { flex:0 0 auto; background:var(--primary-light); padding:8px 12px; border-radius:20px; border:1.5px solid var(--primary); color:var(--primary); font-size:0.8rem; font-weight:700; cursor:pointer; display:flex; align-items:center; gap:5px; transition:transform 0.15s; }
        .shortcut-item:active { transform:scale(0.95); }
        .shortcut-item .remove { color:var(--danger); font-size:1.1rem; margin-left:4px; line-height:1; }

        /* ===== NOUVELLES: Multi-images ===== */
        .images-grid { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:14px; }
        .img-thumb { position:relative; width:90px; height:90px; }
        .img-thumb img { width:100%; height:100%; object-fit:cover; border-radius:12px; border:2.5px solid var(--primary); }
        .img-thumb-remove { position:absolute; top:-8px; right:-8px; background:var(--danger); color:white; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.9rem; font-weight:bold; cursor:pointer; border:2px solid white; z-index:10; }
        .add-photo-btn { width:90px; height:90px; border-radius:12px; border:2px dashed var(--primary); background:var(--primary-light); display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; color:var(--primary); font-size:0.7rem; font-weight:800; gap:4px; flex-shrink:0; }
        .add-photo-btn span { font-size:1.4rem; }

        /* ===== Profil enrichi ===== */
        .profile-section-title {
            font-size:0.7rem; font-weight:900; color:var(--primary);
            text-transform:uppercase; letter-spacing:1.5px;
            margin:20px 0 8px 0;
        }
        .profile-section-title:first-child { margin-top:0; }
        .profile-hint { font-weight:600; text-transform:none; font-size:0.72rem; color:var(--primary); letter-spacing:0; }

        /* S√©lecteur morphotype */
        .morph-selector { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:14px; }
        .morph-opt { border:2px solid rgba(0,0,0,0.08); border-radius:14px; padding:10px 6px; text-align:center; cursor:pointer; transition:all 0.2s; background:var(--bg-body); }
        body.dark-mode .morph-opt { border-color:rgba(255,255,255,0.1); }
        .morph-opt.selected { border-color:var(--primary); background:var(--primary-light); }
        .morph-icon { font-size:1.4rem; }
        .morph-name { font-size:0.72rem; font-weight:800; color:var(--text-color); margin-top:3px; }
        .morph-desc { font-size:0.62rem; color:var(--text-muted); font-weight:600; margin-top:2px; line-height:1.3; }

        /* Aper√ßu calcul objectif */
        .goal-calc-box { background:linear-gradient(135deg,var(--primary-light),rgba(128,90,213,0.08)); border-radius:12px; padding:12px 14px; margin-top:4px; font-size:0.82rem; font-weight:700; line-height:1.8; border-left:3px solid var(--primary); }
        .goal-calc-box .gcb-val { color:var(--primary); font-weight:900; font-size:1rem; }
        .goal-calc-box .gcb-warn { color:#e67e22; font-size:0.75rem; font-weight:700; }

        /* R√©sum√© profil sur accueil */
        .profile-summary { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:12px; }
        .profile-chip { font-size:0.7rem; font-weight:700; padding:4px 10px; border-radius:20px; background:var(--primary-light); color:var(--primary); }

        /* ===== Hydratation ===== */
        .water-card { margin-bottom:14px; }
        .water-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; }
        .water-title { font-weight:900; font-size:0.95rem; }
        .water-stats { font-size:0.8rem; font-weight:700; color:var(--text-muted); }
        .water-stats span { color:#38b2ac; font-weight:900; }
        .water-glasses-row { display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-start; margin-bottom:14px; }

        /* Boutons +/- eau */
        .water-controls { display:flex; align-items:center; justify-content:center; gap:20px; margin-bottom:14px; }
        .water-count-display { text-align:center; min-width:80px; }
        .water-count-num { font-size:2.4rem; font-weight:900; color:#38b2ac; line-height:1; }
        .water-count-sub { font-size:0.72rem; font-weight:700; color:var(--text-muted); margin-top:2px; }
        .water-pm-btn {
            width:48px; height:48px; border-radius:50%;
            border:2px solid #38b2ac; background:rgba(56,178,172,0.1);
            color:#38b2ac; font-size:1.6rem; font-weight:900;
            display:flex; align-items:center; justify-content:center;
            cursor:pointer; transition:all 0.15s; line-height:1; padding:0;
            flex-shrink:0;
        }
        .water-pm-btn:active { transform:scale(0.88); background:rgba(56,178,172,0.25); }
        .water-pm-btn.minus { border-color:rgba(56,178,172,0.4); color:rgba(56,178,172,0.6); background:none; }

        /* Barre de progression eau */
        .water-progress-track { height: 6px; background: rgba(56,178,172,0.15); border-radius:10px; overflow:hidden; margin-bottom:10px; }
        body.dark-mode .water-progress-track { background: rgba(79,209,197,0.12); }
        .water-progress-fill { height:100%; border-radius:10px; background: linear-gradient(90deg, #38b2ac, #805ad5); transition: width 0.5s cubic-bezier(0.34,1.56,0.64,1); }
        .water-footer { display:flex; justify-content:space-between; align-items:center; }
        .water-msg { font-size:0.75rem; font-weight:700; color:var(--text-muted); flex:1; }


        /* ===== Cartes cat√©gories repas ===== */
        .meal-cat-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
        .meal-cat-card {
            background:var(--card-bg); border-radius:20px; padding:20px 14px 16px;
            box-shadow:var(--shadow); border:2px solid transparent;
            cursor:pointer; transition:all 0.2s; text-align:center; position:relative;
            display:flex; flex-direction:column; align-items:center; gap:6px;
        }
        .meal-cat-card:active { transform:scale(0.97); }
        .meal-cat-card.has-meal { border-color:var(--primary); background:var(--primary-light); }
        body.dark-mode .meal-cat-card { border:2px solid rgba(255,255,255,0.06); }
        body.dark-mode .meal-cat-card.has-meal { border-color:var(--primary); }
        .meal-cat-emoji { font-size:2.2rem; line-height:1; }
        .meal-cat-name { font-weight:900; font-size:0.95rem; letter-spacing:-0.3px; }
        .meal-cat-kcal { font-size:0.72rem; font-weight:700; color:var(--text-muted); }
        .meal-cat-kcal span { color:var(--primary); font-weight:800; }
        .meal-cat-badge { position:absolute; top:-6px; right:-6px; background:var(--primary); color:white; font-size:0.65rem; font-weight:900; width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px solid var(--bg-app); }
        .meal-cat-recorded { font-size:0.7rem; color:var(--primary); font-weight:700; margin-top:2px; }
        .meal-cat-add-icon { width:28px; height:28px; border-radius:50%; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-size:1.1rem; margin-top:4px; transition:transform 0.2s; }
        .meal-cat-card:active .meal-cat-add-icon { transform:scale(0.9); }

        /* ===== Macros avec objectif ===== */
        .macro-card-v3 { padding:12px 8px; margin:0; display:flex; flex-direction:column; align-items:center; gap:4px; text-align:center; }
        .macro-val-target { font-size:0.68rem; color:var(--text-muted); font-weight:700; margin-top:1px; }

        /* ===== NOUVELLES: Semaine ===== */
        #week-container { display:flex; overflow-x:auto; gap:8px; padding:4px 16px 14px 16px; margin:0 -16px 4px -16px; scrollbar-width:none; }
        #week-container::-webkit-scrollbar { display:none; }
        .week-card { min-width:56px; flex:0 0 auto; text-align:center; cursor:pointer; border:2px solid transparent; border-radius:14px; padding:10px 6px; transition:all 0.2s; background:var(--bg-body); }
        .week-card .wc-day { font-size:0.68rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; }
        .week-card .wc-num { font-size:1.1rem; font-weight:900; color:var(--text-color); margin-top:2px; }
        .week-card.active-day-card { border-color:var(--primary); background:var(--primary-light); }
        .week-card.active-day-card .wc-num { color:var(--primary); }

        /* ===== Meal items ===== */
        .meal-item { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; background:var(--card-bg); border-radius:12px; margin-bottom:8px; box-shadow:0 2px 8px rgba(0,0,0,0.05); border:1px solid rgba(0,0,0,0.03); }
        body.dark-mode .meal-item { border-color:rgba(255,255,255,0.05); }
        .meal-item-left { display:flex; align-items:center; gap:10px; flex:1; }
        .meal-type-icon { width:38px; height:38px; border-radius:10px; background:var(--primary-light); display:flex; align-items:center; justify-content:center; font-size:1.15rem; flex-shrink:0; }
        .meal-item-name { font-weight:700; font-size:0.9rem; }
        .meal-item-kcal { font-size:0.78rem; color:var(--text-muted); font-weight:600; }
        .meal-delete-btn { background:none; border:none; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--danger); font-size:1.1rem; flex-shrink:0; }
        .macros-mini { display:flex; gap:6px; margin-top:4px; flex-wrap:wrap; }
        .macro-tag { font-size:0.68rem; font-weight:700; padding:2px 6px; border-radius:6px; }
        .macro-tag.p { background:rgba(229,62,62,0.12); color:var(--prot-color); }
        .macro-tag.c { background:rgba(56,161,105,0.12); color:var(--carb-color); }
        .macro-tag.f { background:rgba(214,158,46,0.12); color:var(--fat-color); }

        /* ===== NOUVEAU: Emoji sant√© repas ===== */
        .meal-health-emoji { font-size:1.5rem; flex-shrink:0; margin-right:4px; }

        /* ===== NOUVEAU: Alerte 20% ===== */
        .alert-unhealthy { background:linear-gradient(135deg,#fff5f5,#fed7d7); border-left:4px solid var(--danger); border-radius:12px; padding:14px; margin-bottom:14px; display:none; }
        body.dark-mode .alert-unhealthy { background:linear-gradient(135deg,#2d1515,#3d1a1a); }
        .alert-unhealthy-title { font-weight:800; color:var(--danger); font-size:0.95rem; }
        .alert-unhealthy-msg { font-size:0.82rem; color:var(--text-muted); margin-top:4px; }

        /* ===== NOUVEAU: Courbe de poids ===== */
        .weight-chart { width:100%; height:120px; }
        .weight-entry { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid rgba(0,0,0,0.05); font-size:0.85rem; }
        body.dark-mode .weight-entry { border-bottom-color:rgba(255,255,255,0.05); }
        .weight-entry:last-child { border-bottom:none; }
        .weight-delta-pos { color:var(--danger); font-weight:800; }
        .weight-delta-neg { color:var(--success); font-weight:800; }
        .weight-delta-0 { color:var(--text-muted); font-weight:800; }

        .section-title { font-size:0.72rem; font-weight:800; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin:18px 0 8px 0; }
        .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
        .grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
        .toast { position:fixed; bottom:calc(var(--nav-height) + 20px + env(safe-area-inset-bottom)); left:50%; transform:translateX(-50%) translateY(20px); background:#1a202c; color:white; padding:10px 20px; border-radius:20px; font-size:0.85rem; font-weight:700; z-index:999; opacity:0; transition:all 0.3s; pointer-events:none; white-space:nowrap; }
        body.dark-mode .toast { background:#e2e8f0; color:#1a202c; }
        .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
    </style>
</head>
<body>
<div id="app-container">
    <header>
        <button class="header-btn" id="btn-back" style="visibility:hidden" onclick="goBack()">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <div class="header-title"><span>NUTRI+</span><span class="header-subtitle">Coach IA</span></div>
        <button class="header-btn" onclick="showSection('view-menu')">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
    </header>

    <div id="toast" class="toast"></div>

    <!-- Modal Alerte g√©n√©rale -->
    <div id="modal-alert" class="modal-overlay">
        <div class="modal-box"><h3 id="alert-title">Info</h3><p id="alert-msg">...</p><button onclick="closeAlert()">D'accord</button></div>
    </div>

    <!-- Modal Pas -->
    <div id="modal-steps" class="modal-overlay">
        <div class="modal-box">
            <h3>üèÅ Fin de journ√©e</h3><p>Combien de pas as-tu fait aujourd'hui ?</p>
            <input type="number" id="input-steps-val" placeholder="Ex: 8000" style="text-align:center;font-size:1.3rem;font-weight:900;border-color:var(--primary);margin-bottom:14px">
            <button class="gemini-btn" onclick="finalizeDay(true)">Valider le bilan ‚ú®</button>
            <button class="secondary" style="margin-top:8px" onclick="finalizeDay(false)">Continuer sans les pas</button>
            <button class="outline" style="margin-top:10px" onclick="cancelBilan()">Annuler</button>
        </div>
    </div>

    <!-- Modal Suppression repas -->
    <div id="modal-delete-meal" class="modal-overlay">
        <div class="modal-box"><h3>üóëÔ∏è Supprimer ?</h3><p>Veux-tu vraiment supprimer ce repas ?</p>
            <button class="danger" onclick="confirmDeleteMeal()">Supprimer</button>
            <button class="outline" style="margin-top:8px" onclick="closeDeleteModal()">Annuler</button>
        </div>
    </div>

    <!-- Modal sommeil -->
    <div id="modal-sleep" class="modal-overlay">
        <div class="modal-box">
            <div style="font-size:2rem;margin-bottom:6px">üò¥</div>
            <h3>Sommeil de la nuit</h3>
            <p>Combien d'heures as-tu dormi cette nuit ?</p>
            <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:18px">
                <button onclick="adjustSleep(-0.5)" style="width:44px;height:44px;border-radius:50%;font-size:1.3rem;padding:0;background:var(--primary-light);color:var(--primary);border:2px solid var(--primary)">‚àí</button>
                <div style="text-align:center;min-width:70px">
                    <div id="sleep-input-val" style="font-size:2.8rem;font-weight:900;color:var(--primary);line-height:1">7.0</div>
                    <div style="font-size:0.72rem;font-weight:700;color:var(--text-muted)">heures</div>
                </div>
                <button onclick="adjustSleep(+0.5)" style="width:44px;height:44px;border-radius:50%;font-size:1.3rem;padding:0;background:var(--primary-light);color:var(--primary);border:2px solid var(--primary)">+</button>
            </div>
            <div id="sleep-quality-msg" style="font-size:0.82rem;font-weight:700;text-align:center;margin-bottom:14px;min-height:20px"></div>
            <button class="gemini-btn" onclick="saveSleepEntry()">Enregistrer üíæ</button>
            <button class="outline" style="margin-top:8px" onclick="closeSleepModal()">Annuler</button>
        </div>
    </div>

    <!-- NOUVEAU: Modal mise √† jour du poids -->
    <div id="modal-weight" class="modal-overlay">
        <div class="modal-box">
            <h3>‚öñÔ∏è Mise √† jour du poids</h3>
            <p>Une semaine s'est √©coul√©e ! Entre ton poids actuel pour suivre ta progression.</p>
            <input type="number" id="input-weight-val" placeholder="Ex: 72.5" step="0.1" style="text-align:center;font-size:1.5rem;font-weight:900;border-color:var(--primary);margin-bottom:14px">
            <button class="gemini-btn" onclick="saveWeightEntry()">Enregistrer mon poids</button>
            <button class="outline" style="margin-top:8px" onclick="closeWeightModal()">Plus tard</button>
        </div>
    </div>

    <!-- 0. PROFIL -->
    <div id="view-profile" class="view-section">
        <h2>Ton Profil üë§</h2>

        <!-- Bloc 1 : Identit√© -->
        <div class="profile-section-title">üìã Informations de base</div>
        <div class="card">
            <label>Pr√©nom</label>
            <input type="text" id="p-name" placeholder="Ton pr√©nom">
            <div class="grid-2">
                <div><label>Poids actuel (kg)</label><input type="number" id="p-weight" value="70" min="30" max="300" step="0.1"></div>
                <div><label>Taille (cm)</label><input type="number" id="p-height" value="175" min="100" max="250"></div>
            </div>
            <div class="grid-2">
                <div><label>√Çge</label><input type="number" id="p-age" value="30" min="10" max="100"></div>
                <div>
                    <label>Sexe</label>
                    <select id="p-sex"><option value="male">Homme</option><option value="female">Femme</option></select>
                </div>
            </div>
            <label>Morphotype <span class="profile-hint">influence la r√©partition des macros</span></label>
            <div class="morph-selector" id="morph-selector">
                <div class="morph-opt" data-val="ecto" onclick="selectMorph('ecto')">
                    <div class="morph-icon">ü¶¥</div>
                    <div class="morph-name">Ectomorphe</div>
                    <div class="morph-desc">Mince, du mal √† prendre du poids</div>
                </div>
                <div class="morph-opt" data-val="meso" onclick="selectMorph('meso')">
                    <div class="morph-icon">üí™</div>
                    <div class="morph-name">M√©somorphe</div>
                    <div class="morph-desc">Muscl√© naturellement, poids stable</div>
                </div>
                <div class="morph-opt" data-val="endo" onclick="selectMorph('endo')">
                    <div class="morph-icon">üî•</div>
                    <div class="morph-name">Endomorphe</div>
                    <div class="morph-desc">Tendance √† stocker, prise facile</div>
                </div>
            </div>
        </div>

        <!-- Bloc 2 : Objectif pr√©cis -->
        <div class="profile-section-title">üéØ Objectif</div>
        <div class="card">
            <label>Direction</label>
            <select id="p-goal-dir" onchange="updateGoalUI()">
                <option value="loss">üèÉ Perdre du poids</option>
                <option value="maintain">‚öñÔ∏è Maintenir mon poids</option>
                <option value="gain">üí™ Prise de masse</option>
            </select>
            <div id="goal-target-block">
                <div class="grid-2">
                    <div>
                        <label>Poids cible (kg)</label>
                        <input type="number" id="p-weight-target" placeholder="Ex: 72" step="0.1" min="30" max="300">
                    </div>
                    <div>
                        <label>D√©lai (semaines)</label>
                        <input type="number" id="p-goal-weeks" placeholder="Ex: 12" min="1" max="104">
                    </div>
                </div>
                <div id="goal-calc-preview" class="goal-calc-box" style="display:none"></div>
            </div>
        </div>

        <!-- Bloc 3 : Activit√© & mode de vie -->
        <div class="profile-section-title">üèÉ Activit√© & Mode de vie</div>
        <div class="card">
            <label>Niveau d'activit√© physique</label>
            <select id="p-activity">
                <option value="1.2">S√©dentaire ‚Äî bureau, presque pas de sport</option>
                <option value="1.375" selected>L√©g√®rement actif ‚Äî 1-3 s√©ances/sem.</option>
                <option value="1.55">Mod√©r√©ment actif ‚Äî 3-5 s√©ances/sem.</option>
                <option value="1.725">Tr√®s actif ‚Äî sport quotidien intensif</option>
            </select>
            <label>Fr√©quence de repas souhait√©e <span class="profile-hint">r√©partit les kcal par repas</span></label>
            <select id="p-meal-freq">
                <option value="3">3 repas / jour (classique)</option>
                <option value="4" selected>4 repas / jour (+ 1 collation)</option>
                <option value="5">5 repas / jour (+ 2 collations)</option>
                <option value="2">2 repas / jour (intermittent)</option>
            </select>
            <label>Niveau de stress <span class="profile-hint">impact cortisol</span></label>
            <select id="p-stress">
                <option value="low">Faible üòå</option>
                <option value="medium" selected>Mod√©r√© üòê</option>
                <option value="high">√âlev√© üò§</option>
                <option value="very_high">Tr√®s √©lev√© ü§Ø</option>
            </select>
        </div>

        <!-- Bloc 4 : Pr√©f√©rences alimentaires -->
        <div class="profile-section-title">ü•ó Alimentation & Restrictions</div>
        <div class="card">
            <label>R√©gime alimentaire</label>
            <select id="p-diet">
                <option value="none">Aucun r√©gime particulier</option>
                <option value="vegetarian">ü•¶ V√©g√©tarien</option>
                <option value="vegan">üå± Vegan</option>
                <option value="gluten_free">üåæ Sans gluten</option>
                <option value="halal">‚ò™Ô∏è Halal</option>
                <option value="keto">ü•ë Keto / Low carb</option>
                <option value="paleo">ü•© Pal√©o</option>
            </select>
            <label>Allergies / Intol√©rances <span class="profile-hint">l'IA les exclura de ses conseils</span></label>
            <input type="text" id="p-allergies" placeholder="Ex: lactose, arachides, fruits de mer...">
            <label>Niveau en cuisine</label>
            <select id="p-cooking">
                <option value="beginner">üë∂ D√©butant ‚Äî recettes simples</option>
                <option value="intermediate" selected>üßë‚Äçüç≥ Interm√©diaire</option>
                <option value="advanced">üë®‚Äçüç≥ Confirm√© ‚Äî j'aime cuisiner</option>
            </select>
        </div>

        <!-- Bloc 5 : Contexte IA -->
        <div class="profile-section-title">ü§ñ Contexte pour l'IA</div>
        <div class="card">
            <label>D√©cris ton quotidien <span class="profile-hint">am√©liore la pr√©cision des conseils</span></label>
            <textarea id="p-lifestyle" rows="4" style="resize:none" placeholder="Ex: Je travaille dans un bureau 9h-18h, je fais de la musculation 3x/semaine le soir, je mange souvent √† l'ext√©rieur le midi, j'ai tendance √† grignoter apr√®s 22h..."></textarea>
        </div>

        <button class="gemini-btn" onclick="saveProfile()" style="margin-bottom:20px">Enregistrer mon profil üíæ</button>
    </div>

    <!-- 1. HOME -->
    <div id="view-home" class="view-section">
        <h2>Bonjour <span id="home-user-name">...</span> üëã</h2>
        <div class="profile-summary" id="profile-summary"></div>
        <div id="week-container"></div>

        <!-- NOUVEAU #4: Alerte repas malsains -->
        <div class="alert-unhealthy" id="alert-unhealthy">
            <div class="alert-unhealthy-title">‚ö†Ô∏è Attention √† tes habitudes !</div>
            <div class="alert-unhealthy-msg" id="alert-unhealthy-msg"></div>
        </div>

        <!-- Calories -->
        <div class="card calorie-card" onclick="showSection('view-day')">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                    <div style="font-size:0.7rem;font-weight:800;text-transform:uppercase;color:var(--text-muted);letter-spacing:1px;margin-bottom:4px">Calories du jour</div>
                    <div style="font-size:2.2rem;font-weight:900;color:var(--primary);letter-spacing:-1px">
                        <span id="h-cal">0</span>
                        <span style="font-size:0.95rem;font-weight:600;color:var(--text-muted)"> / <span id="h-target">‚Äî</span> kcal</span>
                    </div>
                    <div id="h-cal-status" style="font-size:0.8rem;font-weight:700;margin-top:4px;color:var(--text-muted)">Touche pour ajouter un repas</div>
                </div>
                <div class="gauge-wrapper" style="width:80px;height:80px">
                    <svg viewBox="0 0 36 36" class="gauge-svg">
                        <path class="gauge-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                        <path id="g-cal-fill" class="gauge-fill" stroke="var(--primary)" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                    </svg>
                    <div class="gauge-icon" style="font-size:1.5rem">üî•</div>
                </div>
            </div>
        </div>

        <!-- MODIFI√â #1: Macros avec valeur / objectif et barre de progression -->
        <div class="grid-3" style="margin-bottom:12px">
            <div class="card macro-card-v3" style="margin:0">
                <span style="font-size:0.62rem;color:var(--text-muted);font-weight:800;text-transform:uppercase">Prot√©ines</span>
                <div class="gauge-wrapper" style="width:38px;height:38px">
                    <svg viewBox="0 0 36 36" class="gauge-svg">
                        <path class="gauge-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                        <path id="g-prot-fill" class="gauge-fill" stroke="var(--prot-color)" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                    </svg>
                    <div class="gauge-icon" style="font-size:0.95rem">ü•©</div>
                </div>
                <div style="font-weight:800;color:var(--prot-color);font-size:0.88rem"><span id="h-prot">0</span>g</div>
                <!-- NOUVEAU: objectif -->
                <div class="macro-val-target">/ <span id="h-prot-target">‚Äî</span>g</div>
                
            </div>
            <div class="card macro-card-v3" style="margin:0">
                <span style="font-size:0.62rem;color:var(--text-muted);font-weight:800;text-transform:uppercase">Glucides</span>
                <div class="gauge-wrapper" style="width:38px;height:38px">
                    <svg viewBox="0 0 36 36" class="gauge-svg">
                        <path class="gauge-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                        <path id="g-carb-fill" class="gauge-fill" stroke="var(--carb-color)" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                    </svg>
                    <div class="gauge-icon" style="font-size:0.95rem">üçû</div>
                </div>
                <div style="font-weight:800;color:var(--carb-color);font-size:0.88rem"><span id="h-carb">0</span>g</div>
                <div class="macro-val-target">/ <span id="h-carb-target">‚Äî</span>g</div>
                
            </div>
            <div class="card macro-card-v3" style="margin:0">
                <span style="font-size:0.62rem;color:var(--text-muted);font-weight:800;text-transform:uppercase">Lipides</span>
                <div class="gauge-wrapper" style="width:38px;height:38px">
                    <svg viewBox="0 0 36 36" class="gauge-svg">
                        <path class="gauge-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                        <path id="g-fat-fill" class="gauge-fill" stroke="var(--fat-color)" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                    </svg>
                    <div class="gauge-icon" style="font-size:0.95rem">ü•ë</div>
                </div>
                <div style="font-weight:800;color:var(--fat-color);font-size:0.88rem"><span id="h-fat">0</span>g</div>
                <div class="macro-val-target">/ <span id="h-fat-target">‚Äî</span>g</div>
                
            </div>
        </div>

        <!-- Sommeil + Sport c√¥te √† c√¥te -->
        <div class="grid-2" style="margin-bottom:14px">
            <div class="card" onclick="openSleepModal()" style="cursor:pointer;display:flex;align-items:center;gap:10px;margin:0;border:1.5px dashed rgba(128,90,213,0.3);background:rgba(128,90,213,0.03)">
                <div style="width:38px;height:38px;border-radius:10px;background:rgba(128,90,213,0.12);display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0">üò¥</div>
                <div style="min-width:0">
                    <div style="font-size:0.6rem;font-weight:800;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Sommeil</div>
                    <div id="h-sleep-val" style="font-weight:800;font-size:0.88rem;color:var(--secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">+ Saisir</div>
                </div>
            </div>
            <div class="card" onclick="showSection('view-training')" style="cursor:pointer;display:flex;align-items:center;gap:10px;margin:0;border:1.5px dashed rgba(56,178,172,0.3);background:rgba(56,178,172,0.03)">
                <div style="width:38px;height:38px;border-radius:10px;background:rgba(56,178,172,0.12);display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0">üèãÔ∏è</div>
                <div style="min-width:0">
                    <div style="font-size:0.6rem;font-weight:800;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Sport</div>
                    <div id="h-sport-val" style="font-weight:800;font-size:0.88rem;color:var(--primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">+ Ajouter</div>
                </div>
            </div>
        </div>

        <!-- Hydratation -->
        <div class="card water-card">
            <div class="water-header">
                <div class="water-title">üíß Hydratation</div>
                <div class="water-stats">Objectif : <span id="w-target">8</span> verres ¬∑ <span id="w-target-l">2</span>L</div>
            </div>
            <div class="water-controls">
                <button class="water-pm-btn minus" onclick="changeWater(-1)">‚àí</button>
                <div class="water-count-display">
                    <div class="water-count-num"><span id="w-current">0</span></div>
                    <div class="water-count-sub"><span id="w-liters">0</span>L ¬∑ <span id="w-pct">0</span>%</div>
                </div>
                <button class="water-pm-btn" onclick="changeWater(+1)">+</button>
            </div>
            <div class="water-progress-track"><div class="water-progress-fill" id="water-progress-fill" style="width:0%"></div></div>
            <div class="water-footer">
                <div class="water-msg" id="water-msg">Pense √† t'hydrater ! üíß</div>
            </div>
        </div>

        <div class="section-title">Repas du jour</div>
        <div id="home-meals-list"></div>

        <!-- Bilan -->
        <div class="card" style="margin-top:6px">
            <div style="display:flex;align-items:center;gap:12px;cursor:pointer" onclick="triggerBilan()">
                <div id="chk-bilan-icon" style="width:26px;height:26px;border-radius:8px;border:2px solid var(--primary);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s;font-size:1rem"></div>
                <div><div style="font-weight:800">Cl√¥turer la journ√©e</div><div style="font-size:0.78rem;color:var(--text-muted)">Analyse IA de ta journ√©e</div></div>
            </div>
            <div id="loader-bilan" class="loader">üß† Le coach analyse ta journ√©e...</div>
            <div id="bilan-text" class="coach-message" style="display:none"></div>
        </div>
    </div>

    <!-- 2. SPORT -->
    <div id="view-training" class="view-section">
        <h2>üèãÔ∏è Sport</h2>
        <div class="section-title">Raccourcis</div>
        <div class="shortcuts-container" id="sport-shortcuts"></div>
        <div class="card">
            <label>Activit√©</label><input type="text" id="t-act" placeholder="Course √† pied, Musculation, V√©lo...">
            <label>Dur√©e (minutes)</label><input type="number" id="t-dur" value="45" min="1">
            <label>Calories montre ‚åö (optionnel)</label><input type="number" id="t-kcal-manual" placeholder="Laisser vide pour utiliser l'IA">
            <div id="loader-sport" class="loader">üß† Estimation de l'IA en cours...</div>
            <div style="display:grid;grid-template-columns:1fr auto;gap:10px;margin-top:6px">
                <button class="gemini-btn" onclick="estimateSport()">Estimation IA ‚ú®</button>
                <button class="outline small" title="Raccourci" onclick="saveAsShortcut()" style="width:50px;font-size:1.2rem">‚≠ê</button>
            </div>
            <div id="t-preview" style="display:none;text-align:center;margin-top:16px;padding:16px;background:var(--primary-light);border-radius:12px">
                <div style="font-size:0.75rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px">Estimation IA</div>
                <div style="font-size:1.8rem;font-weight:900;color:var(--primary);margin:4px 0"><span id="t-kcal-ia">0</span> kcal</div>
                <button class="outline small" style="margin:0 auto" onclick="cancelPreview('t-preview')">Annuler</button>
            </div>
            <button onclick="saveSport()" style="background:var(--success);margin-top:16px">‚úÖ Valider la s√©ance</button>
        </div>
    </div>

    <!-- 3. S√âLECTION CAT√âGORIE REPAS -->
    <div id="view-day" class="view-section">
        <h2>üçΩÔ∏è Ajouter un repas</h2>
        <p style="font-size:0.85rem;color:var(--text-muted);margin:-8px 0 16px 0">S√©lectionne une cat√©gorie pour saisir ton repas</p>
        <div id="meal-categories-grid"></div>
    </div>

    <!-- 3b. FORMULAIRE SAISIE REPAS -->
    <div id="view-meal-form" class="view-section">
        <h2 id="meal-form-title">‚òï Petit D√©jeuner</h2>
        <div class="card">
            <!-- Repas d√©j√† saisis pour cette cat√©gorie -->
            <div id="existing-meals-preview" style="display:none; margin-bottom:14px">
                <div class="section-title" style="margin-top:0">D√©j√† enregistr√©s aujourd'hui</div>
                <div id="existing-meals-list"></div>
            </div>

            <label>Photos du repas <span style="font-weight:600;text-transform:none;font-size:0.75rem;color:var(--primary)">(jusqu'√† 4)</span></label>
            <div class="images-grid" id="images-grid">
                <div class="add-photo-btn" onclick="triggerImportMulti('camera')"><span>üì∏</span>Photo</div>
                <div class="add-photo-btn" onclick="triggerImportMulti('gallery')"><span>üñºÔ∏è</span>Galerie</div>
            </div>

            <label>Description du repas</label>
            <textarea id="m-desc" placeholder="Ex: 150g de poulet grill√©, riz basmati, salade verte..." rows="3" style="resize:none"></textarea>

            <div id="loader-m" class="loader">üîç L'IA analyse ton repas...</div>

            <div id="m-preview" style="display:none" class="card">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
                    <div id="meal-health-emoji" style="font-size:2.5rem;line-height:1">üòä</div>
                    <div>
                        <div style="font-weight:800;font-size:1rem">R√©sultats de l'analyse</div>
                        <div id="meal-health-label" style="font-size:0.82rem;color:var(--text-muted);font-weight:600"></div>
                    </div>
                </div>
                <div class="grid-2">
                    <div><label>Calories (kcal)</label><input type="number" id="m-kcal-val"></div>
                    <div><label>Prot√©ines (g)</label><input type="number" id="m-prot-val"></div>
                </div>
                <div class="grid-2">
                    <div><label>Glucides (g)</label><input type="number" id="m-carb-val"></div>
                    <div><label>Lipides (g)</label><input type="number" id="m-fat-val"></div>
                </div>
                <div class="grid-2" style="margin-top:6px">
                    <button onclick="saveMeal()" style="background:var(--success)">‚úÖ Valider</button>
                    <button class="outline" onclick="cancelPreview('m-preview')">Annuler</button>
                </div>
            </div>
            <button class="gemini-btn" onclick="estimateMeal()" id="btn-analyze-meal">üîç Analyser avec l'IA</button>
        </div>
    </div>

    <!-- 4. OUTILS -->
    <div id="view-menu" class="view-section">
        <h2>üõ†Ô∏è Outils Coach</h2>
        <div class="card">
            <h3>üçΩÔ∏è Scan Menu Restaurant</h3>
            <p style="font-size:0.85rem;color:var(--text-muted);margin:0 0 12px 0">Prends en photo un menu, l'IA te conseille les plats les plus sains.</p>
            <div class="grid-2">
                <button class="secondary" onclick="triggerImport('camera','scan')">üì∏ Photo</button>
                <button class="secondary" onclick="triggerImport('gallery','scan')">üñºÔ∏è Galerie</button>
            </div>
            <div id="loader-scan" class="loader">üîç Analyse du menu...</div>
            <div id="scan-res" class="coach-message" style="display:none"></div>
        </div>
        <div class="card">
            <h3>üë®‚Äçüç≥ Id√©e Recette</h3>
            <p style="font-size:0.85rem;color:var(--text-muted);margin:0 0 10px 0">Dis-moi ce que tu as dans ton frigo !</p>
            <label>Ingr√©dients disponibles</label>
            <input type="text" id="fridge-in" placeholder="Ex: poulet, courgettes, riz...">
            <button class="gemini-btn" onclick="generateRecipe()">üç≥ Trouver une recette</button>
            <div id="loader-recipe" class="loader">üß† Cr√©ation de la recette...</div>
            <div id="recipe-res" class="coach-message" style="display:none"></div>
        </div>

        <!-- NOUVEAU #6: Courbe de poids -->
        <div class="card">
            <h3>‚öñÔ∏è √âvolution du poids</h3>
            <div id="weight-chart-container">
                <div id="weight-empty" style="text-align:center;color:var(--text-muted);font-size:0.85rem;padding:10px">Aucune donn√©e pour l'instant. L'app te demandera de te peser chaque semaine !</div>
                <canvas id="weight-chart" class="weight-chart" style="display:none"></canvas>
                <div id="weight-list" style="margin-top:10px"></div>
            </div>
        </div>

        <div class="card" style="cursor:pointer" onclick="toggleHistory()">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <h3 style="margin:0">üìÖ Historique</h3>
                <svg id="history-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="transition:transform 0.2s"><path d="M6 9l6 6 6-6"/></svg>
            </div>
            <div id="history-list" style="display:none;margin-top:12px"></div>
        </div>
    </div>

    <!-- 5. R√âGLAGES -->
    <div id="view-settings" class="view-section">
        <h2>‚öôÔ∏è R√©glages</h2>
        <div class="card">
            <h3>üîë Cl√© API Gemini</h3>
            <p style="font-size:0.82rem;color:var(--text-muted)">Obtiens ta cl√© gratuite sur <strong>aistudio.google.com</strong></p>
            <label>Ta cl√© API</label>
            <input type="password" id="api-key-in" placeholder="Colle ta cl√© ici...">
            <button onclick="saveApiKey()">Enregistrer la cl√©</button>
        </div>
        <div class="card">
            <button class="outline" onclick="showSection('view-profile')">üë§ Modifier mon profil</button>
            <button class="outline" onclick="toggleTheme()" style="margin-top:10px">üåô Th√®me Sombre / Clair</button>
            <button class="outline" onclick="document.getElementById('modal-weight').style.display='flex'" style="margin-top:10px">‚öñÔ∏è Saisir mon poids</button>
            <button class="danger" style="margin-top:20px" onclick="resetApp()">‚ö†Ô∏è Tout effacer et recommencer</button>
        </div>
        <div class="card" style="text-align:center;padding:20px">
            <div style="font-size:0.75rem;color:var(--text-muted)">NUTRI+ Coach v3.0 ‚ú®</div>
        </div>
    </div>

    <input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none">
    <input type="file" id="gallery-input" accept="image/*" style="display:none">
    <!-- NOUVEAU: input multi-photos -->
    <input type="file" id="multi-camera-input" accept="image/*" capture="environment" style="display:none">
    <input type="file" id="multi-gallery-input" accept="image/*" style="display:none">

    <nav class="bottom-nav">
        <div class="nav-item" onclick="showSection('view-home')">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            <span>Accueil</span>
        </div>
        <div class="nav-fab-wrapper"><div class="nav-fab" onclick="showSection('view-day')">‚ûï</div></div>
        <div class="nav-item" onclick="showSection('view-settings')">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
            <span>R√©glages</span>
        </div>
    </nav>
</div>

<script>
    const MODEL = "gemini-2.5-flash";
    let appData = {
        profile: null, apiKey: "", theme: "light",
        days: {}, shortcuts: [], lastIAKcal: 0, lastMacros: null,
        weightHistory: [],      // NOUVEAU #6
        lastWeightPrompt: null  // NOUVEAU #6
    };

    let selectedDate = getTodayStr();
    let currentImgs = [];   // MODIFI√â #2: tableau de plusieurs images
    let importCtx = "meal";
    let navHistory = [];
    let mealDeleteIndex = null;
    let historyOpen = false;

    function getTodayStr() { return new Date().toISOString().split('T')[0]; }

    // ========================
    // INIT
    // ========================
    window.onload = () => {
        const saved = localStorage.getItem('nutri_v5_pro_complete');
        if (saved) { try { appData = JSON.parse(saved); } catch(e) {} }
        applyTheme();
        // Inputs fichiers
        document.getElementById('camera-input').onchange = function(){ processFile(this); };
        // Listeners calcul objectif en temps r√©el
        ['p-weight-target','p-goal-weeks','p-weight'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', updateGoalPreview);
        });
        document.getElementById('gallery-input').onchange = function(){ processFile(this); };
        document.getElementById('multi-camera-input').onchange = function(){ processMultiFile(this); };
        document.getElementById('multi-gallery-input').onchange = function(){ processMultiFile(this); };
        if (!appData.profile) { showSection('view-profile'); }
        else { initApp(); }
    };

    function initApp() {
        document.querySelectorAll('.loader').forEach(l => l.style.display = 'none');
        document.getElementById('home-user-name').textContent = appData.profile.name;
        document.getElementById('api-key-in').value = appData.apiKey;
        // Remplir le profil
        const p = appData.profile;
        document.getElementById('p-name').value = p.name || '';
        document.getElementById('p-weight').value = p.weight || 70;
        document.getElementById('p-height').value = p.height || 175;
        document.getElementById('p-age').value = p.age || 30;
        if (p.sex) document.getElementById('p-sex').value = p.sex;
        if (p.activity) document.getElementById('p-activity').value = p.activity;
        if (p.lifestyle) document.getElementById('p-lifestyle').value = p.lifestyle;
        // Nouveaux champs profil enrichi
        if (p.morph) { selectedMorph = p.morph; setTimeout(() => selectMorph(p.morph), 50); }
        else { setTimeout(() => selectMorph('meso'), 50); }
        if (p.goalDir) document.getElementById('p-goal-dir').value = p.goalDir;
        if (p.weightTarget) document.getElementById('p-weight-target').value = p.weightTarget;
        if (p.goalWeeks) document.getElementById('p-goal-weeks').value = p.goalWeeks;
        if (p.mealFreq) document.getElementById('p-meal-freq').value = p.mealFreq;
        // p-sleep supprim√© ‚Äî saisi quotidiennement
        if (p.stress) document.getElementById('p-stress').value = p.stress;
        if (p.diet) document.getElementById('p-diet').value = p.diet;
        if (p.allergies) document.getElementById('p-allergies').value = p.allergies;
        if (p.cooking) document.getElementById('p-cooking').value = p.cooking;
        updateGoalUI();

        renderWeek();
        renderHomeData();
        renderShortcuts();
        renderWeightChart();
        checkWeightReminder(); // NOUVEAU #6
        checkUnhealthyAlert(); // NOUVEAU #4
        showSection('view-home');
    }

    // ========================
    // PROFIL ENRICHI
    // ========================
    let selectedMorph = 'meso'; // valeur par d√©faut

    function selectMorph(val) {
        selectedMorph = val;
        document.querySelectorAll('.morph-opt').forEach(el => {
            el.classList.toggle('selected', el.dataset.val === val);
        });
    }

    function updateGoalUI() {
        const dir = document.getElementById('p-goal-dir').value;
        const block = document.getElementById('goal-target-block');
        block.style.display = dir === 'maintain' ? 'none' : 'block';
        updateGoalPreview();
    }

    function updateGoalPreview() {
        const dir = document.getElementById('p-goal-dir').value;
        const weight = parseFloat(document.getElementById('p-weight').value);
        const targetW = parseFloat(document.getElementById('p-weight-target').value);
        const weeks = parseInt(document.getElementById('p-goal-weeks').value);
        const box = document.getElementById('goal-calc-preview');
        if (!targetW || !weeks || isNaN(weight)) { box.style.display = 'none'; return; }
        const diff = targetW - weight;
        const totalKcal = diff * 7700; // 1kg ‚âà 7700 kcal
        const dailyDelta = Math.round(totalKcal / (weeks * 7));
        const absDelta = Math.abs(dailyDelta);
        const isLoss = dailyDelta < 0;
        let warn = '';
        if (absDelta > 1000) warn = '<div class="gcb-warn">‚ö†Ô∏è D√©ficit/surplus √©lev√© ‚Äî rythme agressif, consulte un professionnel</div>';
        else if (absDelta > 700) warn = '<div class="gcb-warn">‚ö° Rythme soutenu ‚Äî reste attentif √† ta r√©cup√©ration</div>';
        box.style.display = 'block';
        box.innerHTML = `
            <div>${isLoss ? 'üìâ' : 'üìà'} √âcart : <span class="gcb-val">${diff > 0 ? '+' : ''}${diff.toFixed(1)} kg</span> en ${weeks} semaines</div>
            <div>Ajustement quotidien : <span class="gcb-val">${isLoss ? '' : '+'}${dailyDelta} kcal/jour</span></div>
            <div style="font-size:0.72rem;color:var(--text-muted);font-weight:600">Rythme : ~${Math.abs(diff/weeks*10)/10} kg/semaine</div>
            ${warn}
        `;
    }

    function saveProfile() {
        const name = document.getElementById('p-name').value.trim();
        const weight = parseFloat(document.getElementById('p-weight').value);
        const height = parseFloat(document.getElementById('p-height').value);
        const age = parseInt(document.getElementById('p-age').value);
        const sex = document.getElementById('p-sex').value;
        const activity = parseFloat(document.getElementById('p-activity').value);
        const lifestyle = document.getElementById('p-lifestyle').value.trim();

        // Nouveaux champs
        const morph = selectedMorph;
        const goalDir = document.getElementById('p-goal-dir').value;
        const weightTarget = parseFloat(document.getElementById('p-weight-target').value) || null;
        const goalWeeks = parseInt(document.getElementById('p-goal-weeks').value) || null;
        const mealFreq = parseInt(document.getElementById('p-meal-freq').value);
        const sleep = null; // Sommeil saisi quotidiennement sur l'accueil
        const stress = document.getElementById('p-stress').value;
        const diet = document.getElementById('p-diet').value;
        const allergies = document.getElementById('p-allergies').value.trim();
        const cooking = document.getElementById('p-cooking').value;

        // Validations
        if (!name) return showAlert("Pr√©nom manquant", "Entre ton pr√©nom pour continuer.");
        if (isNaN(weight) || weight < 30 || weight > 300) return showAlert("Poids invalide", "Entre un poids entre 30 et 300 kg.");
        if (isNaN(height) || height < 100 || height > 250) return showAlert("Taille invalide", "Entre une taille entre 100 et 250 cm.");
        if (isNaN(age) || age < 10 || age > 100) return showAlert("√Çge invalide", "Entre un √¢ge entre 10 et 100 ans.");
        if (goalDir !== 'maintain' && weightTarget) {
            const weeklyRate = Math.abs(weightTarget - weight) / (goalWeeks || 12);
            if (weeklyRate > 1.5) return showAlert("Objectif trop rapide", "Un rythme de plus de 1.5 kg/semaine est risqu√© pour la sant√©. Allonge le d√©lai.");
        }

        // ‚îÄ‚îÄ Calcul BMR (Mifflin-St Jeor) ‚îÄ‚îÄ
        let bmr = sex === 'male'
            ? (10 * weight) + (6.25 * height) - (5 * age) + 5
            : (10 * weight) + (6.25 * height) - (5 * age) - 161;

        // ‚îÄ‚îÄ Ajustement morphotype sur le TDEE ‚îÄ‚îÄ
        // Ecto: m√©tabolisme plus rapide (+3%), Endo: plus lent (-3%)
        const morphMult = { ecto: 1.03, meso: 1.00, endo: 0.97 };
        let tdee = Math.round(bmr * activity * (morphMult[morph] || 1));

        // ‚îÄ‚îÄ Ajustement sommeil ‚îÄ‚îÄ
        // Calcul√© dynamiquement dans le bilan via getAvgSleep7Days(), pas ici

        // ‚îÄ‚îÄ Ajustement stress ‚îÄ‚îÄ
        // Le stress chronique augmente le cortisol ‚Üí r√©tention + besoin accru
        const stressMult = { low: 1.0, medium: 1.0, high: 0.97, very_high: 0.95 };
        // (on r√©duit le TDEE effectif car le cortisol r√©duit l'oxydation des graisses)
        tdee = Math.round(tdee * (stressMult[stress] || 1));

        // ‚îÄ‚îÄ Calcul du delta calorique selon l'objectif pr√©cis ‚îÄ‚îÄ
        let goalDelta = 0;
        if (goalDir === 'loss') {
            if (weightTarget && goalWeeks) {
                const totalKcal = (weightTarget - weight) * 7700;
                goalDelta = Math.max(-1000, Math.round(totalKcal / (goalWeeks * 7)));
            } else { goalDelta = -500; }
        } else if (goalDir === 'gain') {
            if (weightTarget && goalWeeks) {
                const totalKcal = (weightTarget - weight) * 7700;
                goalDelta = Math.min(700, Math.round(totalKcal / (goalWeeks * 7)));
            } else { goalDelta = 400; }
        }
        const calTarget = tdee + goalDelta;

        // ‚îÄ‚îÄ Macros selon morphotype ‚îÄ‚îÄ
        // Ecto: +glucides, Endo: +prot√©ines -glucides
        let protMult = 2.0, fatMult = 0.9;
        if (morph === 'ecto') { protMult = 1.8; fatMult = 0.85; }
        if (morph === 'endo') { protMult = 2.2; fatMult = 0.95; }

        const protTarget = Math.round(weight * protMult);
        const fatTarget = Math.round(weight * fatMult);
        const carbTarget = Math.max(50, Math.round((calTarget - (protTarget * 4) - (fatTarget * 9)) / 4));

        // ‚îÄ‚îÄ R√©partition kcal par repas selon fr√©quence choisie ‚îÄ‚îÄ
        const mealSplit = {
            2: { 'Petit D√©jeuner': 0.40, 'D√©jeuner': 0.60, 'D√Æner': 0, 'Collation': 0 },
            3: { 'Petit D√©jeuner': 0.25, 'D√©jeuner': 0.40, 'D√Æner': 0.35, 'Collation': 0 },
            4: { 'Petit D√©jeuner': 0.25, 'D√©jeuner': 0.35, 'D√Æner': 0.30, 'Collation': 0.10 },
            5: { 'Petit D√©jeuner': 0.20, 'D√©jeuner': 0.30, 'D√Æner': 0.25, 'Collation': 0.125 },
        };

        appData.profile = {
            name, weight, height, age, sex, activity, lifestyle,
            morph, goalDir, weightTarget, goalWeeks, goalDelta,
            mealFreq, sleep, stress, diet, allergies, cooking,
            targets: { cal: calTarget, prot: protTarget, fat: fatTarget, carb: carbTarget },
            mealSplit: mealSplit[mealFreq] || mealSplit[4],
            bmr: Math.round(bmr), tdeeBase: tdee
        };

        if (appData.weightHistory.length === 0) {
            appData.weightHistory.push({ date: getTodayStr(), weight });
        }
        saveData(); initApp(); showToast("Profil enregistr√© !");
    }

    // ========================
    // SEMAINE
    // ========================
    function renderWeek() {
        const container = document.getElementById('week-container');
        container.innerHTML = '';
        const days = ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
        const today = new Date();
        for (let i = 6; i >= 0; i--) {
            const d = new Date(today);
            d.setDate(today.getDate() - i);
            const ds = d.toISOString().split('T')[0];
            const hasData = appData.days[ds] && appData.days[ds].meals.length > 0;
            const div = document.createElement('div');
            div.className = 'week-card' + (ds === selectedDate ? ' active-day-card' : '');
            div.innerHTML = `<div class="wc-day">${days[d.getDay()]}</div><div class="wc-num">${d.getDate()}</div>${hasData ? '<div style="width:5px;height:5px;border-radius:50%;background:var(--primary);margin:3px auto 0"></div>' : ''}`;
            div.onclick = () => { selectedDate = ds; renderWeek(); renderHomeData(); };
            container.appendChild(div);
        }
        const active = container.querySelector('.active-day-card');
        if (active) active.scrollIntoView({ inline: 'center', behavior: 'smooth' });
    }

    // ========================
    // IA
    // ========================
    async function callGemini(prompt, isJson = false, imagesBase64 = []) {
        if (!appData.apiKey) { showAlert("Cl√© API manquante", "Va dans ‚öôÔ∏è R√©glages et entre ta cl√© API Gemini."); return null; }
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${appData.apiKey}`;
        const fullPrompt = isJson ? prompt + " R√©ponds UNIQUEMENT en JSON valide, sans texte avant ni apr√®s, sans balises markdown." : prompt;
        let parts = [{ text: fullPrompt }];
        // MODIFI√â #2: support multi-images
        imagesBase64.forEach(b64 => { if(b64) parts.push({ inlineData: { mimeType: "image/jpeg", data: b64 } }); });
        try {
            const resp = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ contents: [{ parts }] }) });
            const data = await resp.json();
            if (!resp.ok) throw new Error(data.error?.message || "Erreur serveur Google");
            if (!data.candidates?.length) throw new Error("L'IA n'a pas r√©pondu. R√©essaie.");
            const text = data.candidates[0].content.parts[0].text;
            if (isJson) { try { return JSON.parse(text.replace(/```json|```/g,"").trim()); } catch(e) { throw new Error("Format inattendu. R√©essaie."); } }
            return text;
        } catch(e) { showAlert("Erreur IA", e.message); return null; }
    }

    // ========================
    // SPORT
    // ========================
    function renderShortcuts() {
        const c = document.getElementById('sport-shortcuts');
        if (!c) return;
        if (!appData.shortcuts.length) { c.innerHTML = '<div style="font-size:0.8rem;color:var(--text-muted);font-style:italic">Aucun raccourci ‚Äî appuie sur ‚≠ê pour en cr√©er</div>'; return; }
        c.innerHTML = appData.shortcuts.map((s,i) => `<div class="shortcut-item" onclick="loadShortcut(${i})">${s.act} (${s.dur}min) <span class="remove" onclick="event.stopPropagation();deleteShortcut(${i})">√ó</span></div>`).join('');
    }
    function saveAsShortcut() {
        const act = document.getElementById('t-act').value.trim();
        const dur = document.getElementById('t-dur').value;
        if (!act) return showAlert("Activit√© manquante","Entre le nom de l'activit√©.");
        if (appData.shortcuts.find(s=>s.act===act)) return showToast("Raccourci d√©j√† existant !");
        appData.shortcuts.push({act,dur}); saveData(); renderShortcuts(); showToast("Raccourci ajout√© ‚≠ê");
    }
    function loadShortcut(i) { const s=appData.shortcuts[i]; document.getElementById('t-act').value=s.act; document.getElementById('t-dur').value=s.dur; document.getElementById('t-preview').style.display='none'; }
    function deleteShortcut(i) { appData.shortcuts.splice(i,1); saveData(); renderShortcuts(); }

    async function estimateSport() {
        const act = document.getElementById('t-act').value.trim();
        const dur = document.getElementById('t-dur').value;
        if (!act) return showAlert("Activit√© manquante","Pr√©cise l'activit√© sportive.");
        const p = appData.profile;
        const pInfo = p ? `Profil: ${p.weight}kg, ${p.age}ans, ${p.sex==='male'?'homme':'femme'}` : '';
        document.getElementById('loader-sport').style.display = 'block';
        const res = await callGemini(`Estimation calories br√ªl√©es pour "${act}" pendant ${dur} minutes. ${pInfo}. JSON: {"kcal":number}`, true);
        document.getElementById('loader-sport').style.display = 'none';
        if (res?.kcal) { appData.lastIAKcal=res.kcal; document.getElementById('t-kcal-ia').textContent=res.kcal; document.getElementById('t-preview').style.display='block'; }
    }

    function saveSport() {
        const manual = document.getElementById('t-kcal-manual').value !== '' ? parseInt(document.getElementById('t-kcal-manual').value) : NaN;
        const kcal = !isNaN(manual) && manual > 0 ? manual : appData.lastIAKcal;
        const act = document.getElementById('t-act').value.trim();
        if (!kcal || kcal <= 0) return showAlert("Calories manquantes","Saisis les calories ou utilise l'IA.");
        if (!act) return showAlert("Activit√© manquante","Entre le nom de l'activit√©.");
        if (!appData.days[selectedDate]) appData.days[selectedDate] = { meals:[], sport:0, sportEntries:[], closed:false };
        if (!appData.days[selectedDate].sportEntries) appData.days[selectedDate].sportEntries = [];
        appData.days[selectedDate].sport += kcal;
        appData.days[selectedDate].sportEntries.push({act,kcal});
        appData.lastIAKcal = 0;
        saveData(); renderHomeData(); showSection('view-home');
        document.getElementById('t-preview').style.display = 'none';
        document.getElementById('t-kcal-manual').value = '';
        document.getElementById('t-act').value = '';
        showToast("S√©ance enregistr√©e üí™");
    }

    // ========================
    // REPAS ‚Äî multi-images + emoji sant√©
    // ========================

    // NOUVEAU #2: Gestion multi-images
    function triggerImportMulti(mode) {
        if (currentImgs.length >= 4) return showAlert("Maximum atteint","Tu peux ajouter jusqu'√† 4 photos maximum.");
        if (mode === 'camera') document.getElementById('multi-camera-input').click();
        else document.getElementById('multi-gallery-input').click();
    }

    function processMultiFile(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const b64 = e.target.result.split(',')[1];
                currentImgs.push(b64);
                renderImagesGrid();
            };
            reader.readAsDataURL(input.files[0]);
        }
        input.value = "";
    }

    function removeImg(i) {
        currentImgs.splice(i, 1);
        renderImagesGrid();
    }

    function renderImagesGrid() {
        const grid = document.getElementById('images-grid');
        grid.innerHTML = '';
        currentImgs.forEach((b64, i) => {
            const div = document.createElement('div');
            div.className = 'img-thumb';
            div.innerHTML = `<img src="data:image/jpeg;base64,${b64}"><div class="img-thumb-remove" onclick="removeImg(${i})">√ó</div>`;
            grid.appendChild(div);
        });
        if (currentImgs.length < 4) {
            grid.innerHTML += `<div class="add-photo-btn" onclick="triggerImportMulti('camera')"><span>üì∏</span>Photo</div>`;
            grid.innerHTML += `<div class="add-photo-btn" onclick="triggerImportMulti('gallery')"><span>üñºÔ∏è</span>Galerie</div>`;
        }
    }

    // ========================
    // CAT√âGORIES REPAS
    // ========================
    let activeCategory = 'D√©jeuner';

    const MEAL_CATS = [
        { key: 'Petit D√©jeuner', emoji: '‚òï', label: 'Petit D√©jeuner' },
        { key: 'D√©jeuner',       emoji: '‚òÄÔ∏è', label: 'D√©jeuner' },
        { key: 'D√Æner',          emoji: 'üåô', label: 'D√Æner' },
        { key: 'Collation',      emoji: 'üçé', label: 'Collation' },
    ];

    function getMealPct(key) {
        const split = appData.profile?.mealSplit;
        if (split && split[key] !== undefined) return split[key];
        const defaults = { 'Petit D√©jeuner': 0.25, 'D√©jeuner': 0.35, 'D√Æner': 0.30, 'Collation': 0.10 };
        return defaults[key] || 0.10;
    }

    function renderMealCategories() {
        const grid = document.getElementById('meal-categories-grid');
        if (!grid) return;
        const targets = appData.profile ? appData.profile.targets : { cal: 2000 };
        const day = appData.days[selectedDate] || { meals: [] };
        grid.innerHTML = '<div class="meal-cat-grid"></div>';
        const inner = grid.querySelector('.meal-cat-grid');

        MEAL_CATS.forEach(cat => {
            const idealKcal = Math.round(targets.cal * getMealPct(cat.key));
            const meals = day.meals.filter(m => m.type === cat.key);
            const totalKcal = meals.reduce((s, m) => s + m.kcal, 0);
            const count = meals.length;
            const hasMeal = count > 0;

            const card = document.createElement('div');
            card.className = 'meal-cat-card' + (hasMeal ? ' has-meal' : '');
            card.innerHTML = `
                ${count > 0 ? `<div class="meal-cat-badge">${count}</div>` : ''}
                <div class="meal-cat-emoji">${cat.emoji}</div>
                <div class="meal-cat-name">${cat.label}</div>
                <div class="meal-cat-kcal">Id√©al : <span>~${idealKcal} kcal</span></div>
                ${hasMeal ? `<div class="meal-cat-recorded">${totalKcal} kcal enregistr√©s</div>` : ''}
                <div class="meal-cat-add-icon">+</div>
            `;
            card.onclick = () => openMealForm(cat.key);
            inner.appendChild(card);
        });
    }

    function openMealForm(category) {
        activeCategory = category;
        const cat = MEAL_CATS.find(c => c.key === category);
        const targets = appData.profile ? appData.profile.targets : { cal: 2000 };
        const idealKcal = Math.round(targets.cal * getMealPct(cat.key));

        // Titre de la page formulaire
        document.getElementById('meal-form-title').textContent = cat.emoji + ' ' + cat.label;

        // Afficher les repas d√©j√† enregistr√©s pour cette cat√©gorie
        const day = appData.days[selectedDate] || { meals: [] };
        const existing = day.meals.map((m, i) => ({...m, _idx: i})).filter(m => m.type === category);
        const prevEl = document.getElementById('existing-meals-preview');
        const prevList = document.getElementById('existing-meals-list');
        if (existing.length > 0) {
            prevEl.style.display = 'block';
            prevList.innerHTML = existing.map(m => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:var(--primary-light);border-radius:10px;margin-bottom:6px">
                    <div>
                        <div style="font-weight:700;font-size:0.88rem">${cat.emoji} ${m.kcal} kcal</div>
                        <div style="font-size:0.72rem;color:var(--text-muted)">P:${m.prot}g G:${m.carb}g L:${m.fat}g</div>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px">
                        ${m.healthScore ? (['','üòü','üòê','üòä'][m.healthScore] || '') : ''}
                        <button class="meal-delete-btn" onclick="askDeleteMeal(${m._idx})" style="font-size:1rem">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        } else {
            prevEl.style.display = 'none';
        }

        // Reset formulaire
        clearImages();
        document.getElementById('m-desc').value = '';
        cancelPreview('m-preview');

        // Placeholder adapt√©
        const subtitles = {
            'Petit D√©jeuner': 'Ex: 2 ≈ìufs brouill√©s, toast complet, caf√©...',
            'D√©jeuner': 'Ex: 150g poulet, riz basmati, l√©gumes vapeur...',
            'D√Æner': 'Ex: Saumon grill√©, quinoa, salade verte...',
            'Collation': 'Ex: Pomme, amandes, yaourt grec...'
        };
        document.getElementById('m-desc').placeholder = subtitles[category] || 'D√©cris ton repas...';
        document.getElementById('loader-m').style.display = 'none';
        document.getElementById('btn-analyze-meal').style.display = 'flex';

        showSection('view-meal-form');
    }

    // Analyse repas avec emoji sant√©
    async function estimateMeal() {
        const desc = document.getElementById('m-desc').value.trim();
        if (!desc && !currentImgs.length) return showAlert("Info","Ajoute une description ou une photo de ton repas.");
        document.getElementById('loader-m').style.display = 'block';
        document.getElementById('btn-analyze-meal').style.display = 'none';
        document.getElementById('m-preview').style.display = 'none';

        const promptParts = [];
        if (desc) promptParts.push(`Description du repas: "${desc}"`);
        if (currentImgs.length) promptParts.push(`${currentImgs.length} photo(s) du repas jointe(s).`);

        const profile = appData.profile;
        const goalStr = profile?.goal < 0 ? 'perte de poids' : profile?.goal > 0 ? 'prise de masse' : 'maintien';
        const cat = MEAL_CATS.find(c => c.key === activeCategory);
        const idealKcal = cat ? Math.round((profile?.targets?.cal || 2000) * getMealPct(cat.key)) : 600;

        const prompt = `${promptParts.join('. ')}. Type de repas: ${activeCategory} (objectif ~${idealKcal} kcal pour ce repas). Objectif utilisateur: ${goalStr}.
Analyse ce repas, estime les valeurs nutritionnelles et donne un score de sant√© (1=mauvais, 2=moyen, 3=bon) par rapport √† l'objectif.
R√©ponds JSON: {"kcal":number,"prot":number,"carb":number,"fat":number,"healthScore":1|2|3,"healthLabel":string}`;

        const res = await callGemini(prompt, true, currentImgs);
        document.getElementById('loader-m').style.display = 'none';

        if (res) {
            document.getElementById('m-kcal-val').value = res.kcal || 0;
            document.getElementById('m-prot-val').value = res.prot || 0;
            document.getElementById('m-carb-val').value = res.carb || 0;
            document.getElementById('m-fat-val').value = res.fat || 0;
            const emojis = { 1: 'üòü', 2: 'üòê', 3: 'üòä' };
            document.getElementById('meal-health-emoji').textContent = emojis[res.healthScore] || 'üòê';
            document.getElementById('meal-health-label').textContent = res.healthLabel || '';
            document.getElementById('m-preview').style.display = 'block';
            appData.lastMacros = res;
        } else {
            document.getElementById('btn-analyze-meal').style.display = 'flex';
        }
    }

    function saveMeal() {
        if (!appData.days[selectedDate]) appData.days[selectedDate] = { meals:[], sport:0, sportEntries:[], closed:false };
        const meal = {
            type: activeCategory,
            kcal: parseInt(document.getElementById('m-kcal-val').value) || 0,
            prot: parseInt(document.getElementById('m-prot-val').value) || 0,
            carb: parseInt(document.getElementById('m-carb-val').value) || 0,
            fat: parseInt(document.getElementById('m-fat-val').value) || 0,
            healthScore: appData.lastMacros?.healthScore || 2,
            healthLabel: appData.lastMacros?.healthLabel || ''
        };
        appData.days[selectedDate].meals.push(meal);
        saveData(); clearImages(); renderHomeData(); renderMealCategories();
        cancelPreview('m-preview');
        document.getElementById('m-desc').value = '';
        checkUnhealthyAlert();
        // Rester sur le formulaire pour permettre une saisie suppl√©mentaire (collation)
        // Mais si ce n'est pas une collation, retourner aux cat√©gories
        if (activeCategory === 'Collation') {
            // Rafra√Æchir l'affichage des collations existantes
            openMealForm('Collation');
            showToast("Collation ajout√©e ‚úÖ ‚Äî tu peux en ajouter une autre !");
        } else {
            showSection('view-day');
            showToast("Repas ajout√© ‚úÖ");
        }
    }

    function clearImages() {
        currentImgs = [];
        renderImagesGrid();
    }

    // NOUVEAU #4: V√©rification alerte 20% repas malsains sur 7 jours
    function checkUnhealthyAlert() {
        const alertEl = document.getElementById('alert-unhealthy');
        const msgEl = document.getElementById('alert-unhealthy-msg');
        // Collecter tous les repas des 7 derniers jours
        let totalMeals = 0, unhealthyMeals = 0;
        const today = new Date();
        for (let i = 0; i < 7; i++) {
            const d = new Date(today);
            d.setDate(today.getDate() - i);
            const ds = d.toISOString().split('T')[0];
            const day = appData.days[ds];
            if (day) {
                day.meals.forEach(m => {
                    totalMeals++;
                    if (m.healthScore === 1) unhealthyMeals++;
                });
            }
        }
        if (totalMeals >= 3) {
            const pct = Math.round((unhealthyMeals / totalMeals) * 100);
            if (pct > 20) {
                alertEl.style.display = 'block';
                msgEl.textContent = `${pct}% de tes repas des 7 derniers jours sont peu adapt√©s √† ton objectif (limite : 20%). C'est le moment d'ajuster ! üí™`;
            } else {
                alertEl.style.display = 'none';
            }
        } else {
            alertEl.style.display = 'none';
        }
    }

    // Suppression repas
    function askDeleteMeal(index) { mealDeleteIndex = index; document.getElementById('modal-delete-meal').style.display = 'flex'; }
    function confirmDeleteMeal() {
        if (mealDeleteIndex !== null && appData.days[selectedDate]) {
            appData.days[selectedDate].meals.splice(mealDeleteIndex, 1);
            mealDeleteIndex = null;
            saveData(); renderHomeData(); checkUnhealthyAlert();
        }
        closeDeleteModal(); showToast("Repas supprim√©");
    }
    function closeDeleteModal() { document.getElementById('modal-delete-meal').style.display = 'none'; mealDeleteIndex = null; }

    // ========================
    // BILAN
    // ========================
    function triggerBilan() {
        const day = appData.days[selectedDate] || { closed: false };
        if (day.closed) { day.closed = false; day.aiSummary = ""; saveData(); renderHomeData(); return; }
        document.getElementById('modal-steps').style.display = 'flex';
    }
    function cancelBilan() { document.getElementById('modal-steps').style.display = 'none'; }
    function cancelPreview(id) {
        document.getElementById(id).style.display = 'none';
        if (id === 'm-preview') document.getElementById('btn-analyze-meal').style.display = 'flex';
    }

    async function finalizeDay(hasSteps) {
        document.getElementById('modal-steps').style.display = 'none';
        if (!appData.days[selectedDate]) appData.days[selectedDate] = { meals:[], sport:0, sportEntries:[], steps:0, closed:false };
        const day = appData.days[selectedDate];
        if (hasSteps) day.steps = parseInt(document.getElementById('input-steps-val').value) || 0;
        day.closed = true; renderHomeData();
        document.getElementById('loader-bilan').style.display = 'block';
        const p = appData.profile;
        const t = p.targets;
        // MODIFI√â #3: on inclut le lifestyle dans le prompt du bilan
        const lifestyleInfo = p.lifestyle ? `Quotidien: ${p.lifestyle}.` : '';
        const dietInfo = p.diet && p.diet !== 'none' ? `R√©gime: ${p.diet}.` : '';
        const stressInfo = p.stress ? `Stress: ${p.stress}.` : '';
        const sleepToday = day.sleep;
        const sleepAvg = getAvgSleep7Days();
        const sleepInfo = sleepToday
            ? `Sommeil cette nuit: ${sleepToday.toFixed(1)}h (moyenne 7j: ${sleepAvg.toFixed(1)}h).`
            : sleepAvg !== 7 ? `Moyenne sommeil 7j: ${sleepAvg.toFixed(1)}h.` : '';
        const allergiesInfo = p.allergies ? `Allergies/intol√©rances: ${p.allergies}.` : '';
        const goalInfo = p.goalDir === 'loss' && p.weightTarget ? `Objectif: atteindre ${p.weightTarget}kg en ${p.goalWeeks} semaines.` : '';
        const prompt = `Tu es un coach nutritionnel bienveillant. Analyse cette journ√©e et donne un conseil court, encourageant et personnalis√© (3-4 phrases max).
Profil: ${p.name}, ${p.weight}kg, morphotype ${p.morph || 'meso'}. ${goalInfo} ${lifestyleInfo} ${dietInfo} ${stressInfo} ${sleepInfo} ${allergiesInfo}
Objectifs: ${t.cal} kcal, ${t.prot}g prot√©ines, ${t.carb}g glucides, ${t.fat}g lipides.
Journ√©e: ${JSON.stringify({ calories: day.meals.reduce((s,m)=>s+m.kcal,0), proteines: day.meals.reduce((s,m)=>s+m.prot,0), glucides: day.meals.reduce((s,m)=>s+(m.carb||0),0), lipides: day.meals.reduce((s,m)=>s+(m.fat||0),0), sport: day.sport, pas: day.steps||0, eau_litres: ((day.water||0)*0.25).toFixed(1), eau_objectif_litres: (getWaterTarget()*0.25).toFixed(1) })}.`;
        const txt = await callGemini(prompt, false);
        document.getElementById('loader-bilan').style.display = 'none';
        day.aiSummary = txt; saveData(); renderHomeData();
    }

    // ========================
    // RENDER HOME ‚Äî avec barres de progression macros
    // ========================
    function renderHomeData() {
        // R√©sum√© profil en chips
        const sumEl = document.getElementById('profile-summary');
        if (sumEl && appData.profile) {
            const p = appData.profile;
            const goalLabels = { loss:'Perte de poids', maintain:'Maintien', gain:'Prise de masse' };
            const morphLabels = { ecto:'Ectomorphe', meso:'M√©somorphe', endo:'Endomorphe' };
            const chips = [];
            if (p.targets?.cal) chips.push(`üî• ${p.targets.cal} kcal/j`);
            if (p.goalDir) chips.push(goalLabels[p.goalDir] || '');
            if (p.weightTarget) chips.push(`üéØ ${p.weightTarget} kg`);
            if (p.morph) chips.push(morphLabels[p.morph] || '');
            const avgSleep = getAvgSleep7Days();
            if (avgSleep !== 7) chips.push(`üò¥ moy. ${avgSleep.toFixed(1)}h`);
            // Eau du jour dans les chips
            const todayWater = (appData.days[getTodayStr()]?.water || 0) * 0.25;
            const waterTarget = getWaterTarget() * 0.25;
            if (todayWater > 0) chips.push(`üíß ${todayWater.toFixed(1)}/${waterTarget.toFixed(1)}L`);
            sumEl.innerHTML = chips.filter(Boolean).map(c => `<span class="profile-chip">${c}</span>`).join('');
        }
        const day = appData.days[selectedDate] || { meals:[], sport:0, closed:false, aiSummary:"" };
        const targets = appData.profile ? appData.profile.targets : { cal:2000, prot:100, carb:200, fat:60 };
        let total = { cal:0, prot:0, carb:0, fat:0 };
        day.meals.forEach(m => { total.cal+=m.kcal; total.prot+=m.prot; total.carb+=(m.carb||0); total.fat+=(m.fat||0); });
        const adjCal = targets.cal + (day.sport || 0);

        document.getElementById('h-cal').textContent = total.cal;
        document.getElementById('h-target').textContent = adjCal;
        document.getElementById('h-prot').textContent = total.prot;
        document.getElementById('h-carb').textContent = total.carb;
        document.getElementById('h-fat').textContent = total.fat;

        // NOUVEAU #1: afficher les objectifs sous chaque macro
        document.getElementById('h-prot-target').textContent = targets.prot;
        document.getElementById('h-carb-target').textContent = targets.carb;
        document.getElementById('h-fat-target').textContent = targets.fat;



        const remaining = adjCal - total.cal;
        const statusEl = document.getElementById('h-cal-status');
        if (total.cal === 0) statusEl.textContent = "Touche pour ajouter un repas";
        else if (remaining > 0) statusEl.textContent = `Il te reste ${remaining} kcal`;
        else statusEl.textContent = `Objectif d√©pass√© de ${Math.abs(remaining)} kcal`;

        const setG = (id, v, t) => { const el = document.getElementById(`g-${id}-fill`); if(el) el.style.strokeDashoffset = 100 - Math.min((v/(t||1))*100,100); };
        setG('cal',total.cal,adjCal); setG('prot',total.prot,targets.prot); setG('carb',total.carb,targets.carb); setG('fat',total.fat,targets.fat);

        document.getElementById('h-sport-val').textContent = (day.sport||0) > 0 ? `+ ${day.sport} kcal br√ªl√©es` : "+ Ajouter une s√©ance";

        // Eau du jour
        renderWaterGlasses();

        // Sommeil du jour
        const sleepEl = document.getElementById('h-sleep-val');
        if (sleepEl) {
            const s = day.sleep;
            sleepEl.textContent = s ? `${getSleepEmoji(s)} ${s.toFixed(1)}h` : '+ Saisir';
        }

        const chkIcon = document.getElementById('chk-bilan-icon');
        if (day.closed) { chkIcon.textContent='‚úì'; chkIcon.style.background='var(--primary)'; chkIcon.style.color='white'; }
        else { chkIcon.textContent=''; chkIcon.style.background='transparent'; }

        const bText = document.getElementById('bilan-text');
        if (day.closed && day.aiSummary) { bText.textContent=day.aiSummary; bText.style.display='block'; }
        else { bText.style.display='none'; }

        // Liste repas avec emoji sant√© #5
        const mealIcons = { 'Petit D√©jeuner':'‚òï','D√©jeuner':'‚òÄÔ∏è','D√Æner':'üåô','Collation':'üçé' };
        const healthEmojis = { 1:'üòü', 2:'üòê', 3:'üòä' };
        const list = document.getElementById('home-meals-list');
        list.innerHTML = '';
        if (!day.meals.length) {
            list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:0.9rem">Aucun repas enregistr√© pour ce jour</div>';
        } else {
            day.meals.forEach((m, i) => {
                const el = document.createElement('div');
                el.className = 'meal-item';
                el.innerHTML = `
                    <div class="meal-item-left">
                        <div class="meal-type-icon">${mealIcons[m.type]||'üçΩÔ∏è'}</div>
                        <div>
                            <div class="meal-item-name">${m.type}</div>
                            <div class="meal-item-kcal">${m.kcal} kcal</div>
                            <div class="macros-mini">
                                <span class="macro-tag p">P: ${m.prot}g</span>
                                <span class="macro-tag c">G: ${m.carb}g</span>
                                <span class="macro-tag f">L: ${m.fat}g</span>
                            </div>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:6px">
                        ${m.healthScore ? `<span title="${m.healthLabel||''}" style="font-size:1.4rem">${healthEmojis[m.healthScore]||''}</span>` : ''}
                        <button class="meal-delete-btn" onclick="askDeleteMeal(${i})" title="Supprimer">üóëÔ∏è</button>
                    </div>`;
                list.appendChild(el);
            });
        }
    }

    // ========================
    // IMPORT IMAGE (scan menu)
    // ========================
    function triggerImport(mode, ctx='meal') {
        importCtx = ctx;
        if (mode === 'camera') document.getElementById('camera-input').click();
        else document.getElementById('gallery-input').click();
    }
    function processFile(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => { const b64 = e.target.result.split(',')[1]; analyzeMenu(b64); };
            reader.readAsDataURL(input.files[0]);
        }
        input.value = "";
    }

    // ========================
    // OUTILS
    // ========================
    async function analyzeMenu(b64) {
        const resDiv = document.getElementById('scan-res');
        const loader = document.getElementById('loader-scan');
        resDiv.style.display = 'none'; loader.style.display = 'block';
        const res = await callGemini("Analyse ce menu de restaurant. Conseille les 2 plats les plus sains en expliquant bri√®vement pourquoi. Sois concis et bienveillant.", false, [b64]);
        loader.style.display = 'none';
        if (res) { resDiv.textContent = res; resDiv.style.display = 'block'; }
    }

    async function generateRecipe() {
        const ing = document.getElementById('fridge-in').value.trim();
        if (!ing) return showAlert("Ingr√©dients manquants","Liste ce que tu as dans ton frigo !");
        const resDiv = document.getElementById('recipe-res');
        const loader = document.getElementById('loader-recipe');
        resDiv.style.display = 'none'; loader.style.display = 'block';
        const res = await callGemini(`Propose une recette saine, simple et rapide avec ces ingr√©dients: ${ing}. Inclus les √©tapes et une estimation des calories.`);
        loader.style.display = 'none';
        if (res) { resDiv.textContent = res; resDiv.style.display = 'block'; }
    }

    // ========================
    // HYDRATATION
    // ========================

    function getWaterTarget() {
        // Formule : 35ml √ó poids (kg) + bonus activit√© + bonus stress
        const p = appData.profile;
        if (!p) return 8; // d√©faut 8 verres = 2L
        let ml = p.weight * 35;
        // +500ml si activit√© mod√©r√©e/√©lev√©e
        if (parseFloat(p.activity) >= 1.55) ml += 500;
        // +250ml si stress √©lev√©
        if (p.stress === 'high' || p.stress === 'very_high') ml += 250;
        // +250ml si perte de poids (m√©tabolisme accru)
        if (p.goalDir === 'loss') ml += 250;
        // Arrondir au verre le plus proche (1 verre = 250ml)
        return Math.max(6, Math.min(12, Math.round(ml / 250)));
    }

    function renderWaterGlasses() {
        var day    = appData.days[selectedDate] || {};
        var filled = day.water || 0;
        var target = getWaterTarget();
        var liters = (filled * 0.25).toFixed(2).replace(/\.?0+$/, '') || '0';
        var pct    = Math.round(Math.min((filled / target) * 100, 100));

        var elCur = document.getElementById('w-current');
        var elLit = document.getElementById('w-liters');
        var elPct = document.getElementById('w-pct');
        var elTgt = document.getElementById('w-target');
        var elTgtL = document.getElementById('w-target-l');
        var pfill  = document.getElementById('water-progress-fill');
        var msgEl  = document.getElementById('water-msg');

        if (elCur)  elCur.textContent  = filled;
        if (elLit)  elLit.textContent  = liters;
        if (elPct)  elPct.textContent  = pct;
        if (elTgt)  elTgt.textContent  = target;
        if (elTgtL) elTgtL.textContent = (target * 0.25).toFixed(2).replace(/\.?0+$/, '');
        if (pfill)  pfill.style.width  = pct + '%';

        if (msgEl) {
            if      (filled === 0)          msgEl.textContent = "Pense √† t'hydrater ! üíß";
            else if (filled < target * 0.4) msgEl.textContent = "Continue, tu es bien parti ! üåä";
            else if (filled < target * 0.7) msgEl.textContent = "Bonne progression ! üëç";
            else if (filled < target)       msgEl.textContent = "Plus que " + (target - filled) + " verre(s) !";
            else                            msgEl.textContent = "Objectif atteint ! üéâ";
        }
    }

    function changeWater(delta) {
        if (!appData.days[selectedDate]) {
            appData.days[selectedDate] = { meals:[], sport:0, sportEntries:[], closed:false };
        }
        var day = appData.days[selectedDate];
        day.water = Math.max(0, Math.min(20, (day.water || 0) + delta));
        saveData();
        renderWaterGlasses();
    }

        // ========================
    // SUIVI SOMMEIL QUOTIDIEN
    // ========================
    let sleepInputVal = 7.0;

    function openSleepModal() {
        const day = appData.days[selectedDate] || {};
        sleepInputVal = day.sleep || 7.0;
        document.getElementById('sleep-input-val').textContent = sleepInputVal.toFixed(1);
        updateSleepQualityMsg();
        document.getElementById('modal-sleep').style.display = 'flex';
    }

    function closeSleepModal() {
        document.getElementById('modal-sleep').style.display = 'none';
    }

    function adjustSleep(delta) {
        sleepInputVal = Math.min(12, Math.max(2, sleepInputVal + delta));
        document.getElementById('sleep-input-val').textContent = sleepInputVal.toFixed(1);
        updateSleepQualityMsg();
    }

    function updateSleepQualityMsg() {
        const el = document.getElementById('sleep-quality-msg');
        if (sleepInputVal < 5) {
            el.textContent = 'üî¥ Tr√®s insuffisant ‚Äî impact fort sur m√©tabolisme & app√©tit';
            el.style.color = 'var(--danger)';
        } else if (sleepInputVal < 6.5) {
            el.textContent = 'üü† Insuffisant ‚Äî la faim sera plus difficile √† contr√¥ler';
            el.style.color = '#e67e22';
        } else if (sleepInputVal < 7.5) {
            el.textContent = 'üü° Correct ‚Äî un peu plus aiderait la r√©cup√©ration';
            el.style.color = '#d69e2e';
        } else if (sleepInputVal <= 9) {
            el.textContent = 'üü¢ Optimal ‚Äî bonne r√©cup√©ration, m√©tabolisme au top !';
            el.style.color = 'var(--success)';
        } else {
            el.textContent = 'üîµ Tr√®s long ‚Äî v√©rifie ta qualit√© de sommeil';
            el.style.color = 'var(--primary)';
        }
    }

    function saveSleepEntry() {
        if (!appData.days[selectedDate]) {
            appData.days[selectedDate] = { meals:[], sport:0, sportEntries:[], closed:false };
        }
        appData.days[selectedDate].sleep = sleepInputVal;
        saveData();
        closeSleepModal();
        renderHomeData();
        showToast(`Sommeil enregistr√© : ${sleepInputVal.toFixed(1)}h üò¥`);
    }

    function getSleepEmoji(h) {
        if (!h) return '';
        if (h < 5) return 'üî¥';
        if (h < 6.5) return 'üü†';
        if (h < 7.5) return 'üü°';
        if (h <= 9) return 'üü¢';
        return 'üîµ';
    }

    function getAvgSleep7Days() {
        // Moyenne mobile sur 7 jours pour le calcul TDEE
        const today = new Date();
        let total = 0, count = 0;
        for (let i = 0; i < 7; i++) {
            const d = new Date(today);
            d.setDate(today.getDate() - i);
            const ds = d.toISOString().split('T')[0];
            const s = appData.days[ds]?.sleep;
            if (s) { total += s; count++; }
        }
        return count > 0 ? total / count : 7; // d√©faut 7h si pas de donn√©es
    }

    // ========================
    // NOUVEAU #6: Suivi du poids
    // ========================
    function checkWeightReminder() {
        const lastPrompt = appData.lastWeightPrompt;
        const today = getTodayStr();
        if (!lastPrompt) { appData.lastWeightPrompt = today; saveData(); return; }
        const diffDays = Math.floor((new Date(today) - new Date(lastPrompt)) / (1000*60*60*24));
        if (diffDays >= 7) {
            setTimeout(() => { document.getElementById('modal-weight').style.display = 'flex'; }, 1500);
        }
    }

    function saveWeightEntry() {
        const val = parseFloat(document.getElementById('input-weight-val').value);
        if (isNaN(val) || val < 30 || val > 300) return showAlert("Poids invalide","Entre un poids valide.");
        if (!appData.weightHistory) appData.weightHistory = [];
        appData.weightHistory.push({ date: getTodayStr(), weight: val });
        appData.lastWeightPrompt = getTodayStr();
        // Mettre √† jour le poids du profil
        if (appData.profile) appData.profile.weight = val;
        saveData();
        closeWeightModal();
        renderWeightChart();
        showToast("Poids enregistr√© ‚öñÔ∏è");
    }

    function closeWeightModal() {
        document.getElementById('modal-weight').style.display = 'none';
        appData.lastWeightPrompt = getTodayStr();
        saveData();
    }

    function renderWeightChart() {
        const history = appData.weightHistory || [];
        const emptyEl = document.getElementById('weight-empty');
        const canvas = document.getElementById('weight-chart');
        const listEl = document.getElementById('weight-list');
        if (history.length < 2) { emptyEl.style.display='block'; canvas.style.display='none'; listEl.innerHTML=''; return; }
        emptyEl.style.display = 'none';
        canvas.style.display = 'block';

        // Dessiner la courbe sur canvas
        const ctx = canvas.getContext('2d');
        const W = canvas.offsetWidth || 300;
        const H = 120;
        canvas.width = W; canvas.height = H;
        ctx.clearRect(0,0,W,H);

        const weights = history.map(e=>e.weight);
        const minW = Math.min(...weights) - 1;
        const maxW = Math.max(...weights) + 1;
        const pad = { l:30, r:10, t:10, b:20 };
        const chartW = W - pad.l - pad.r;
        const chartH = H - pad.t - pad.b;

        const toX = (i) => pad.l + (i/(history.length-1)) * chartW;
        const toY = (w) => pad.t + (1 - (w-minW)/(maxW-minW)) * chartH;

        // Fond gradient
        const isDark = document.body.classList.contains('dark-mode');
        const lineColor = isDark ? '#4fd1c5' : '#38b2ac';
        const grad = ctx.createLinearGradient(0, pad.t, 0, H);
        grad.addColorStop(0, isDark ? 'rgba(79,209,197,0.3)' : 'rgba(56,178,172,0.2)');
        grad.addColorStop(1, 'rgba(0,0,0,0)');

        // Zone remplie
        ctx.beginPath();
        ctx.moveTo(toX(0), H);
        history.forEach((e,i) => ctx.lineTo(toX(i), toY(e.weight)));
        ctx.lineTo(toX(history.length-1), H);
        ctx.closePath();
        ctx.fillStyle = grad;
        ctx.fill();

        // Ligne
        ctx.beginPath();
        history.forEach((e,i) => { if(i===0) ctx.moveTo(toX(i),toY(e.weight)); else ctx.lineTo(toX(i),toY(e.weight)); });
        ctx.strokeStyle = lineColor;
        ctx.lineWidth = 2.5;
        ctx.lineJoin = 'round';
        ctx.stroke();

        // Points
        history.forEach((e,i) => {
            ctx.beginPath();
            ctx.arc(toX(i), toY(e.weight), 4, 0, Math.PI*2);
            ctx.fillStyle = lineColor;
            ctx.fill();
        });

        // Labels Y
        ctx.fillStyle = isDark ? '#a0aec0' : '#718096';
        ctx.font = '10px Nunito, sans-serif';
        ctx.textAlign = 'right';
        ctx.fillText(maxW.toFixed(1), pad.l-4, pad.t+6);
        ctx.fillText(minW.toFixed(1), pad.l-4, H-pad.b);

        // Liste des entr√©es
        listEl.innerHTML = '';
        const sorted = [...history].reverse();
        sorted.forEach((e, i) => {
            const prev = sorted[i+1];
            let deltaHtml = '';
            if (prev) {
                const diff = (e.weight - prev.weight).toFixed(1);
                const cls = diff > 0 ? 'weight-delta-pos' : diff < 0 ? 'weight-delta-neg' : 'weight-delta-0';
                const sign = diff > 0 ? '+' : '';
                deltaHtml = `<span class="${cls}">${sign}${diff} kg</span>`;
            }
            listEl.innerHTML += `<div class="weight-entry"><span>${formatDate(e.date)}</span><div style="display:flex;gap:10px;align-items:center">${deltaHtml}<span style="font-weight:800">${e.weight} kg</span></div></div>`;
        });
    }

    // ========================
    // HISTORIQUE
    // ========================
    function toggleHistory() {
        historyOpen = !historyOpen;
        const list = document.getElementById('history-list');
        const chevron = document.getElementById('history-chevron');
        list.style.display = historyOpen ? 'block' : 'none';
        chevron.style.transform = historyOpen ? 'rotate(180deg)' : 'rotate(0deg)';
        if (historyOpen) {
            list.innerHTML = '';
            const keys = Object.keys(appData.days).sort().reverse();
            if (!keys.length) { list.innerHTML='<div style="color:var(--text-muted);font-size:0.85rem">Aucun historique pour l\'instant.</div>'; return; }
            keys.forEach(d => {
                const day = appData.days[d];
                const total = day.meals.reduce((s,m)=>s+m.kcal,0);
                const el = document.createElement('div');
                el.className = 'card';
                el.style.cssText = 'padding:12px;cursor:pointer;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center';
                el.innerHTML = `<div><div style="font-weight:800">${formatDate(d)}</div><div style="font-size:0.8rem;color:var(--text-muted)">${day.meals.length} repas ‚Ä¢ ${day.closed?'‚úÖ Cl√¥tur√©':'‚è≥ En cours'}</div></div><div style="font-weight:900;color:var(--primary)">${total} kcal</div>`;
                el.onclick = () => { selectedDate=d; renderWeek(); renderHomeData(); showSection('view-home'); };
                list.appendChild(el);
            });
        }
    }

    function formatDate(ds) {
        const d = new Date(ds+'T12:00:00');
        return d.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'});
    }

    // ========================
    // NAVIGATION
    // ========================
    function showSection(id) {
        const current = document.querySelector('.view-section.active');
        if (current && current.id !== id) navHistory.push(current.id);
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('btn-back').style.visibility = id==='view-home' ? 'hidden' : 'visible';
        if (id === 'view-menu') renderWeightChart();
        if (id === 'view-day') renderMealCategories();
        window.scrollTo(0,0);
    }
    function goBack() {
        if (navHistory.length > 0) { const prev=navHistory.pop(); showSection(prev); navHistory.pop(); }
        else { showSection('view-home'); }
    }

    // ========================
    // TH√àME & DONN√âES
    // ========================
    function toggleTheme() { appData.theme=(appData.theme==='light'?'dark':'light'); applyTheme(); saveData(); showToast(appData.theme==='dark'?"Mode sombre activ√© üåô":"Mode clair activ√© ‚òÄÔ∏è"); }
    function applyTheme() { document.body.classList.toggle('dark-mode', appData.theme==='dark'); }
    function saveData() { localStorage.setItem('nutri_v5_pro_complete', JSON.stringify(appData)); }
    function saveApiKey() { appData.apiKey=document.getElementById('api-key-in').value.trim(); saveData(); showToast("Cl√© API enregistr√©e üîë"); }
    function resetApp() {
        showAlert("‚ö†Ô∏è Attention","Pour tout effacer, ferme cette alerte puis clique √† nouveau sur Reset.");
        if (!window._resetConfirm) { window._resetConfirm=true; setTimeout(()=>{window._resetConfirm=false;},5000); return; }
        localStorage.clear(); location.reload();
    }
    function showAlert(t,m) { document.getElementById('alert-title').textContent=t; document.getElementById('alert-msg').textContent=m; document.getElementById('modal-alert').style.display='flex'; }
    function closeAlert() { document.getElementById('modal-alert').style.display='none'; }
    function showToast(msg) { const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }
</script>
</body>
</html>
